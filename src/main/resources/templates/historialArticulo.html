<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial del Artículo - Sistema de Inventarios</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>
<body>
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<div class="contenido">
    <h1><ion-icon name="time-outline"></ion-icon> Historial del Artículo</h1>

    <!-- Información del artículo -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h2 style="margin-bottom: 10px;">
                    <ion-icon name="cube-outline"></ion-icon>
                    <span th:text="${articulo.codigo}"></span> -
                    <span th:text="${articulo.descripcion}"></span>
                </h2>
                <div style="display: flex; gap: 20px; margin-top: 10px;">
                    <div>
                        <p><strong><ion-icon name="cube-outline"></ion-icon> Unidad:</strong>
                            <span th:text="${articulo.unidad}"></span></p>
                    </div>
                    <div>
                        <p><strong><ion-icon name="cash-outline"></ion-icon> Precio:</strong>
                            <span th:text="${articulo.precio != null ? 'S/ ' + #numbers.formatDecimal(articulo.precio, 1, 'POINT', 2, 'COMMA') : 'S/ 0.00'}"></span></p>
                    </div>
                    <div>
                        <p><strong><ion-icon name="archive-outline"></ion-icon> Stock Actual:</strong>
                            <span th:text="${articulo.inventarioFinal}"></span></p>
                    </div>
                </div>
            </div>
            <div>
                <a th:href="@{/articulos/gestionar}" class="btn-cancelar">
                    <ion-icon name="arrow-back-outline"></ion-icon> Volver
                </a>
                <a th:href="@{'/articulos/editar/' + ${articulo.id}}" class="btn-primary" style="margin-left: 10px;">
                    <ion-icon name="create-outline"></ion-icon> Editar
                </a>
            </div>
        </div>
    </div>

    <!-- Historial del artículo -->
    <div class="card" style="margin-top: 20px;">
        <h2><ion-icon name="list-outline"></ion-icon> Historial de Movimientos</h2>

        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Cantidad</th>
                    <th>Motivo</th>
                    <th>Stock Anterior</th>
                    <th>Stock Nuevo</th>
                    <th>Diferencia</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="movimiento : ${historial}"
                    th:class="${movimiento.tipoMovimiento == 'ENTRADA'} ? 'movimiento-entrada' : 'movimiento-salida'">
                    <td th:text="${movimiento.fechaFormateada}"></td>
                    <td>
                                <span th:if="${movimiento.tipoMovimiento == 'ENTRADA'}" class="badge-entrada">
                                    <ion-icon name="arrow-down-circle"></ion-icon> ENTRADA
                                </span>
                        <span th:if="${movimiento.tipoMovimiento == 'SALIDA'}" class="badge-salida">
                                    <ion-icon name="arrow-up-circle"></ion-icon> SALIDA
                                </span>
                    </td>
                    <td class="table-number" th:text="${movimiento.cantidad}"></td>
                    <td th:text="${movimiento.motivo}"></td>
                    <td class="table-number" th:text="${movimiento.stockAnterior}"></td>
                    <td class="table-number" th:text="${movimiento.stockNuevo}"></td>
                    <td class="table-number">
                                <span th:if="${movimiento.tipoMovimiento == 'ENTRADA'}" style="color: #28a745; font-weight: bold;">
                                    +<span th:text="${movimiento.cantidad}"></span>
                                </span>
                        <span th:if="${movimiento.tipoMovimiento == 'SALIDA'}" style="color: #dc3545; font-weight: bold;">
                                    -<span th:text="${movimiento.cantidad}"></span>
                                </span>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(historial)}">
                    <td colspan="7" style="text-align: center; padding: 40px;">
                        <ion-icon name="alert-circle-outline" style="font-size: 48px; color: #6c757d;"></ion-icon>
                        <p style="margin-top: 10px;">No hay movimientos registrados para este artículo</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        <div th:if="${totalPaginas > 1}" class="paginacion">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                <div>
                    <span>Mostrando <span th:text="${historial.size()}"></span> de <span th:text="${totalElementos}"></span> movimientos</span>
                </div>

                <div style="display: flex; gap: 5px;">
                    <a th:href="@{'/movimientos/historial/articulo/' + ${articulo.id}(page=0, size=${size})}"
                       th:classappend="${paginaActual == 0} ? 'disabled' : ''"
                       class="btn-paginacion">
                        <ion-icon name="chevron-back-outline"></ion-icon>
                    </a>

                    <a th:if="${paginaActual > 0}"
                       th:href="@{'/movimientos/historial/articulo/' + ${articulo.id}(page=${paginaActual-1}, size=${size})}"
                       class="btn-paginacion">
                        <ion-icon name="arrow-back-outline"></ion-icon>
                    </a>

                    <span th:each="i : ${#numbers.sequence(0, totalPaginas-1)}"
                          th:if="${(i >= paginaActual-2 and i <= paginaActual+2) or i == 0 or i == totalPaginas-1}">
                            <a th:href="@{'/movimientos/historial/articulo/' + ${articulo.id}(page=${i}, size=${size})}"
                               th:text="${i+1}"
                               th:classappend="${i == paginaActual} ? 'active' : ''"
                               class="btn-paginacion">
                            </a>
                        </span>

                    <a th:if="${paginaActual < totalPaginas-1}"
                       th:href="@{'/movimientos/historial/articulo/' + ${articulo.id}(page=${paginaActual+1}, size=${size})}"
                       class="btn-paginacion">
                        <ion-icon name="arrow-forward-outline"></ion-icon>
                    </a>

                    <a th:href="@{'/movimientos/historial/articulo/' + ${articulo.id}(page=${totalPaginas-1}, size=${size})}"
                       th:classappend="${paginaActual == totalPaginas-1} ? 'disabled' : ''"
                       class="btn-paginacion">
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </a>
                </div>

                <div>
                    <select onchange="cambiarTamanio(this)" class="select-tamanio">
                        <option value="10" th:selected="${size == 10}">10 por página</option>
                        <option value="20" th:selected="${size == 20}">20 por página</option>
                        <option value="50" th:selected="${size == 50}">50 por página</option>
                        <option value="100" th:selected="${size == 100}">100 por página</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen estadístico -->
    <div class="card" style="margin-top: 20px;">
        <h2><ion-icon name="stats-chart-outline"></ion-icon> Resumen Estadístico</h2>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
            <div style="text-align: center; padding: 20px; background: #e9ecef; border-radius: 8px;">
                <ion-icon name="arrow-down-circle-outline" style="font-size: 36px; color: #28a745;"></ion-icon>
                <h3 style="margin: 10px 0 5px 0;">Total Entradas</h3>
                <p style="font-size: 24px; font-weight: bold; color: #28a745;"
                   th:text="${articulo.entradas}"></p>
            </div>
            <div style="text-align: center; padding: 20px; background: #e9ecef; border-radius: 8px;">
                <ion-icon name="arrow-up-circle-outline" style="font-size: 36px; color: #dc3545;"></ion-icon>
                <h3 style="margin: 10px 0 5px 0;">Total Salidas</h3>
                <p style="font-size: 24px; font-weight: bold; color: #dc3545;"
                   th:text="${articulo.salidas}"></p>
            </div>
            <div style="text-align: center; padding: 20px; background: #e9ecef; border-radius: 8px;">
                <ion-icon name="trending-up-outline" style="font-size: 36px; color: #17a2b8;"></ion-icon>
                <h3 style="margin: 10px 0 5px 0;">Movimientos Totales</h3>
                <p style="font-size: 24px; font-weight: bold; color: #17a2b8;"
                   th:text="${totalElementos}"></p>
            </div>
            <div style="text-align: center; padding: 20px; background: #e9ecef; border-radius: 8px;">
                <ion-icon name="calculator-outline" style="font-size: 36px; color: #722f37;"></ion-icon>
                <h3 style="margin: 10px 0 5px 0;">Stock Actual</h3>
                <p style="font-size: 24px; font-weight: bold; color: #722f37;"
                   th:text="${articulo.inventarioFinal}"></p>
            </div>
        </div>
    </div>
</div>

<script>
    function cambiarTamanio(select) {
        const size = select.value;
        const url = new URL(window.location.href);
        url.searchParams.set('size', size);
        url.searchParams.set('page', 0);
        window.location.href = url.toString();
    }
</script>
</body>
</html>